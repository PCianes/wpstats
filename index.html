<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link rel="profile" href="http://gmpg.org/xfn/11">
	<link rel="stylesheet" href="https://unpkg.com/tachyons@4.6.1/css/tachyons.min.css"/>
	<!--[if lt IE 9]>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
	<![endif]-->
</head>
<body>

	<div class="w-100 bg-light-red pa5">

		<div class="center tc">
			<h1 class="f1 fw3 lh-title white mv2">WordPress.org Download Stats</h1>
			<h3 class="f4 fw3 lh-subtitle black-80 mt2 mb4">Enter a plugin or theme slug to view the download stats</h3>
			<form id="search-form">
				<input id="search-input" type="text" placeholder="e.g. jetpack" class="input-reset pv3 b1 b--black-60 o0 ph3 br2 w80 w-60-ns f4 fw3 black-80" value=""/>
			</form>
		</div>

	</div>

	<div class="plugin pv3"></div>

	<div class="chart-container w-80 center mb4">
		<canvas id="chart" class="" width="100%" height="100%"></canvas>
	</div>


	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.0/backbone-min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>

	<script>
		Chart.defaults.global.maintainAspectRatio = false;
		Chart.defaults.global.scaleLabel = "<%=parseInt(value).toLocaleString()%>";


		$( '#search-form' ).on( 'submit', function() {
			var search_slug = $( '#search-input' ).val();
			app_router.navigate( 'plugin/' + search_slug, true );
		});

		var AppRouter = Backbone.Router.extend({
			routes: {
				"plugin/:slug": "getPlugin",
				"*actions": "defaultRoute"
			}
		});
		// Initiate the router
		var app_router = new AppRouter;

		app_router.on('route:getPlugin', function(slug) {

			$( '#search-input' ).val( slug );

			// $.ajax({
			// 	url: 'https://api.wordpress.org/plugins/info/1.0/' + slug + '.json',
			// 	type: "GET",
			// 	cache: false,
			// 	dataType: "jsonp",
			// 	success : function(response) {
			// 		// console.log( response );
			// 		var template = _.template( $( '#plugin-details' ).html(), { plugin: { title: "test" } } );
			// 		$( '.plugin' ).html( template );
			// 	}
			// });



			$.ajax({
				url: 'https://api.wordpress.org/stats/plugin/1.0/downloads.php?slug=' + slug + '&limit=30',
				type: "GET",
				cache: false,
				dataType: "jsonp",
				success : function(response) {
					$( '.plugin-missing-wrap' ).remove();
					$( '#chart' ).remove();

					if ( 1 === _.keys( response ).length && 0 === response[ Object.keys( response )[0] ] ) {
						var template = _.template( $( '#plugin-missing' ).html() );
						$( '.plugin' ).html( template );
					} else {
						$( '.chart-container' ).append( '<canvas id="chart" class="" width="100%" height="100%"></canvas>' );

						var ctx = document.getElementById( 'chart' ).getContext( '2d' );
						ctx.canvas.width = 300;
						ctx.canvas.height = 450;

						var keys = [];
						var values = [];
						_.each( response, function( val, key ) {
							formattedKey = new Date( key ).toLocaleDateString( 'en-gb', {
								day : 'numeric',
								month : 'short',
								timeZone : 'UTC'
								// year : 'numeric'
							});

							keys.push( formattedKey );
							values.push( val );
						});

						var myChart = new Chart(ctx, {
							type: 'bar',
							data: {
								labels: keys,
								datasets: [{
									label: '# of Downloads',
									data: values,
									borderWidth: 1,
									backgroundColor: '#357edd'
								}]
							},
							options: {
								scales: {
									yAxes: [{
										ticks: {
											callback: function (value, index, values) {
												return value.toLocaleString();
											},
											// stepSize: 500000,
											beginAtZero:true
										}
									}]
								}
							}
						});
					}

				}
			});

		});

		app_router.on('route:defaultRoute', function(actions) {
			alert(actions);
		});

		// Start Backbone history a necessary step for bookmarkable URL's
		Backbone.history.start();
	</script>

	<script type="text/template" id="plugin-details">
		<h2 class="f3 fw4"><% plugin.title %></h2>
	</script>

	<script type="text/template" id="plugin-missing">
		<div class="plugin-missing-wrap w-80 center tc">
			<h2 class="f2 fw3 blue">Plugin Not Found</h2>
			<h4 class="f4 fw3 black-80">No plugin exists for that slug. If you've just uploaded it try again in a day or so.</h4>
		</div>
	</script>

	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-78288291-2', 'auto');
	  ga('send', 'pageview');

	</script>

</body>
</html>
